<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHubç™»å½•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h2 {
            color: #666;
            margin-top: 0;
        }
        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a8b;
        }
        .iframe-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 600px;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .log-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007cba;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” GitHubç™»å½•æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“¡ æµ‹è¯•è¯´æ˜</h2>
            <div class="status info">
                <strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯GitHubç™»å½•è¡¨å•æ˜¯å¦è¢«æ­£ç¡®æ‹¦æˆªå’Œå¤„ç†<br>
                <strong>æµ‹è¯•æ­¥éª¤:</strong> ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åŠ è½½GitHubç™»å½•é¡µé¢ï¼Œç„¶åå°è¯•ç™»å½•<br>
                <strong>é¢„æœŸç»“æœ:</strong> è¡¨å•æäº¤åº”è¯¥è¢«æ‹¦æˆªå¹¶é€šè¿‡ä»£ç†å¤„ç†ï¼Œè€Œä¸æ˜¯ç›´æ¥æäº¤
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸš€ åŠ è½½GitHubç™»å½•é¡µé¢</h2>
            <button onclick="loadGitHubLogin()">åŠ è½½GitHubç™»å½•é¡µé¢</button>
            <button onclick="loadGitHubSignup()">åŠ è½½GitHubæ³¨å†Œé¡µé¢</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="iframe-container">
            <iframe id="test-iframe" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š è°ƒè¯•æ—¥å¿—</h2>
            <div id="log-container" class="log-container">
                ç­‰å¾…æ“ä½œ...
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•</h2>
            <button onclick="testFormSubmit()">æµ‹è¯•è¡¨å•æäº¤</button>
            <button onclick="testDirectProxy()">æµ‹è¯•ç›´æ¥ä»£ç†</button>
            <div id="manual-test-result" class="status" style="display: none;"></div>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('test-iframe');
        const logContainer = document.getElementById('log-container');
        const manualTestResult = document.getElementById('manual-test-result');
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logContainer.innerHTML = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }
        
        // åŠ è½½GitHubç™»å½•é¡µé¢
        function loadGitHubLogin() {
            addLog('æ­£åœ¨åŠ è½½GitHubç™»å½•é¡µé¢...');
            const proxyUrl = 'http://localhost:9999/proxy?url=https://github.com/login';
            iframe.src = proxyUrl;
        }
        
        // åŠ è½½GitHubæ³¨å†Œé¡µé¢
        function loadGitHubSignup() {
            addLog('æ­£åœ¨åŠ è½½GitHubæ³¨å†Œé¡µé¢...');
            const proxyUrl = 'http://localhost:9999/proxy?url=https://github.com/signup';
            iframe.src = proxyUrl;
        }
        
        // æµ‹è¯•è¡¨å•æäº¤
        async function testFormSubmit() {
            addLog('æµ‹è¯•è¡¨å•æäº¤...');
            manualTestResult.style.display = 'block';
            manualTestResult.className = 'status info';
            manualTestResult.innerHTML = 'æ­£åœ¨æµ‹è¯•è¡¨å•æäº¤...';
            
            try {
                const proxyUrl = 'http://localhost:9999/proxy?url=https://httpbin.org/post';
                const formData = new URLSearchParams();
                formData.append('username', 'testuser');
                formData.append('password', 'testpass');
                formData.append('login', 'Sign in');
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const text = await response.text();
                    addLog(`è¡¨å•æäº¤æµ‹è¯•æˆåŠŸ! å“åº”é•¿åº¦: ${text.length} å­—ç¬¦`);
                    manualTestResult.className = 'status success';
                    manualTestResult.innerHTML = `âœ… è¡¨å•æäº¤æµ‹è¯•æˆåŠŸ!<br>çŠ¶æ€ç : ${response.status}<br>å“åº”é•¿åº¦: ${text.length} å­—ç¬¦`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`è¡¨å•æäº¤æµ‹è¯•å¤±è´¥: ${error.message}`);
                manualTestResult.className = 'status error';
                manualTestResult.innerHTML = `âŒ è¡¨å•æäº¤æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•ç›´æ¥ä»£ç†
        async function testDirectProxy() {
            addLog('æµ‹è¯•ç›´æ¥ä»£ç†è®¿é—®...');
            manualTestResult.style.display = 'block';
            manualTestResult.className = 'status info';
            manualTestResult.innerHTML = 'æ­£åœ¨æµ‹è¯•ç›´æ¥ä»£ç†...';
            
            try {
                const proxyUrl = 'http://localhost:9999/proxy?url=https://github.com/login';
                const response = await fetch(proxyUrl);
                
                if (response.ok) {
                    const text = await response.text();
                    addLog(`ç›´æ¥ä»£ç†æµ‹è¯•æˆåŠŸ! å“åº”é•¿åº¦: ${text.length} å­—ç¬¦`);
                    manualTestResult.className = 'status success';
                    manualTestResult.innerHTML = `âœ… ç›´æ¥ä»£ç†æµ‹è¯•æˆåŠŸ!<br>çŠ¶æ€ç : ${response.status}<br>å“åº”é•¿åº¦: ${text.length} å­—ç¬¦`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`ç›´æ¥ä»£ç†æµ‹è¯•å¤±è´¥: ${error.message}`);
                manualTestResult.className = 'status error';
                manualTestResult.innerHTML = `âŒ ç›´æ¥ä»£ç†æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // ç›‘å¬æ¥è‡ªiframeçš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'navigate') {
                addLog(`æ”¶åˆ°å¯¼èˆªæ¶ˆæ¯: ${event.data.url}`);
                
                // å¤„ç†å¯¼èˆª - åœ¨iframeä¸­åŠ è½½æ–°é¡µé¢
                try {
                    const url = event.data.url;
                    if (url && url !== iframe.src) {
                        addLog(`æ­£åœ¨å¯¼èˆªåˆ°: ${url}`);
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨ä»£ç†
                        if (shouldUseProxy(url)) {
                            const proxyUrl = getProxyUrl(url);
                            addLog(`ä½¿ç”¨ä»£ç†å¯¼èˆª: ${url} -> ${proxyUrl}`);
                            iframe.src = proxyUrl;
                        } else {
                            addLog(`ç›´æ¥å¯¼èˆª: ${url}`);
                            iframe.src = url;
                        }
                    }
                } catch (error) {
                    addLog(`å¯¼èˆªå¤„ç†å¤±è´¥: ${error.message}`);
                }
            } else if (event.data && event.data.type === 'submit-form') {
                addLog(`æ”¶åˆ°è¡¨å•æäº¤æ¶ˆæ¯:`);
                addLog(`  æ–¹æ³•: ${event.data.method}`);
                addLog(`  URL: ${event.data.url}`);
                addLog(`  æ•°æ®: ${JSON.stringify(event.data.data, null, 2)}`);
                
                // æ¨¡æ‹Ÿè¡¨å•æäº¤å¤„ç†
                handleFormSubmission(event.data);
            }
        });
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨ä»£ç†
        function shouldUseProxy(url) {
            if (url.startsWith('about:') || 
                url.startsWith('data:') || 
                url.startsWith('blob:') ||
                url.startsWith('javascript:') ||
                url.includes('localhost:8089') ||
                url.includes('localhost:9999')) {
                return false;
            }
            return url.startsWith('http://') || url.startsWith('https://');
        }
        
        // è·å–ä»£ç†URL
        function getProxyUrl(url) {
            const proxyBaseUrl = 'http://localhost:9999/proxy';
            return `${proxyBaseUrl}?url=${encodeURIComponent(url)}`;
        }
        
        // å¤„ç†è¡¨å•æäº¤
        async function handleFormSubmission(formData) {
            addLog('å¼€å§‹å¤„ç†è¡¨å•æäº¤...');
            
            try {
                const { method, url, data } = formData;
                const proxyUrl = `http://localhost:9999/proxy?url=${encodeURIComponent(url)}`;
                
                addLog(`æäº¤åˆ°ä»£ç†: ${url} -> ${proxyUrl}`);
                
                const fetchOptions = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
                    }
                };
                
                if (data && Object.keys(data).length > 0) {
                    const params = new URLSearchParams();
                    for (const [key, value] of Object.entries(data)) {
                        if (value !== null && value !== undefined) {
                            params.append(key, value.toString());
                        }
                    }
                    fetchOptions.body = params.toString();
                    addLog(`è¡¨å•æ•°æ®: ${fetchOptions.body}`);
                }
                
                const response = await fetch(proxyUrl, fetchOptions);
                addLog(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const content = await response.text();
                    addLog(`å“åº”å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
                    
                    // åˆ›å»ºæ–°çš„é¡µé¢æ˜¾ç¤ºç»“æœ
                    const blob = new Blob([content], { type: 'text/html' });
                    const resultUrl = URL.createObjectURL(blob);
                    iframe.src = resultUrl;
                    
                    addLog('è¡¨å•æäº¤å¤„ç†å®Œæˆï¼Œå·²åŠ è½½ç»“æœé¡µé¢');
                } else {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} - ${response.statusText}`);
                }
                
            } catch (error) {
                addLog(`è¡¨å•æäº¤å¤„ç†å¤±è´¥: ${error.message}`);
            }
        }
        
        // iframeåŠ è½½äº‹ä»¶
        iframe.addEventListener('load', function() {
            addLog(`iframeåŠ è½½å®Œæˆ: ${iframe.src}`);
        });
        
        iframe.addEventListener('error', function() {
            addLog(`iframeåŠ è½½å¤±è´¥: ${iframe.src}`);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            addLog('GitHubç™»å½•æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html> 